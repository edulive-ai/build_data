<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Processing Application</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-main">
                    <h1>üìö PDF Processing & Question Manager</h1>
                    <p>X·ª≠ l√Ω PDF v√† qu·∫£n l√Ω c√¢u h·ªèi th√¥ng minh</p>
                </div>
                <div class="header-auth">
                    <div id="userInfo" class="user-info-header" style="display: none;">
                        <div class="user-details-header">
                            <div id="usernameDisplay" class="user-name-header"></div>
                            <div id="userRoleDisplay" class="user-role-header"></div>
                        </div>
                    </div>
                    <button id="logoutBtn" class="logout-btn-header" style="display: none;">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                            <path d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
                        </svg>
                        ƒêƒÉng xu·∫•t
                    </button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="tab-btn active" onclick="showTab('mapping')">üìù Mapping Questions</button>
                <button class="tab-btn" onclick="showTab('upload')">üì§ Upload PDF</button>
                <button class="tab-btn" onclick="showTab('gallery')">üñºÔ∏è Gallery</button>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Main Content -->
        <div class="main-content-3col">
            <!-- Form Section -->
            <div class="form-section">
                <div class="section-title">üìù Th√™m C√¢u H·ªèi M·ªõi</div>
                
                <!-- Book Selection -->
                <div class="form-group">
                    <label for="bookSelect">üìö Ch·ªçn s√°ch:</label>
                    <select id="bookSelect" class="book-select" onchange="onBookChange()">
                        <option value="">ƒêang t·∫£i...</option>
                    </select>
                </div>

                <!-- Folder Selection -->
                <div class="form-group">
                    <label for="folderSelect">üìÅ Ch·ªçn folder ·∫£nh:</label>
                    <select id="folderSelect" class="folder-select" onchange="loadImagesFromFolder()">
                        <option value="">-- Ch·ªçn folder ·∫£nh --</option>
                    </select>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <div class="quick-actions-title">‚ö° Quick Actions cho Images</div>
                    <div class="quick-actions-buttons">
                        <button onclick="showFullSizeImages()" class="quick-btn" title="Hi·ªÉn th·ªã ·∫£nh full size ƒë·ªÉ th·∫•y to√†n b·ªô n·ªôi dung">
                            üñºÔ∏è Full Size
                        </button>
                        <button onclick="fitAllImages()" class="quick-btn" title="V·ª´a kh√≠t v·ªõi khung hi·ªÉn th·ªã">
                            üîç Fit All
                        </button>
                        <button onclick="showCompactImages()" class="quick-btn" title="Hi·ªÉn th·ªã g·ªçn ƒë·ªÉ xem nhi·ªÅu ·∫£nh">
                            üì± Compact
                        </button>
                        <button onclick="setImageViewMode('auto-height')" class="quick-btn" title="Chi·ªÅu cao t·ª± ƒë·ªông theo n·ªôi dung ·∫£nh">
                            üìè Auto Height
                        </button>
                    </div>
                </div>

                <!-- Helper Text -->
                <div class="helper-text">
                    üí° <strong>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:</strong>
                    <ul>
                        <li>Click ·∫£nh ƒë·ªÉ ch·ªçn cho c√¢u h·ªèi/ƒë√°p √°n</li>
                        <li>Ctrl+Click ƒë·ªÉ xem preview ·∫£nh l·ªõn</li>
                        <li>Ph√≠m t·∫Øt: 1=Auto Height, 2=Fixed, 3=Adaptive</li>
                        <li>Ctrl+F ƒë·ªÉ Fit All, Ctrl +/- ƒë·ªÉ thay ƒë·ªïi k√≠ch th∆∞·ªõc</li>
                    </ul>
                </div>

                <!-- Images Grid -->
                <div id="imagesGrid" class="images-grid"></div>

                <!-- Text Content Display -->
                <div id="textContentGroup" style="display: none;">
                    <div class="text-content-header">
                        <h4>üìÑ N·ªôi dung Text:</h4>
                        <div>
                            <button id="editTextBtn" class="btn btn-small">‚úèÔ∏è S·ª≠a</button>
                            <button id="saveTextBtn" class="btn btn-small" style="display: none;">üíæ L∆∞u</button>
                            <button id="cancelTextBtn" class="btn btn-small" style="display: none;">‚ùå H·ªßy</button>
                        </div>
                    </div>
                    <div id="textDisplay" class="text-display"></div>
                    <textarea id="textEditor" class="text-editor" style="display: none;"></textarea>
                </div>

                <!-- Selection Controls -->
                <div class="selection-buttons">
                    <button id="selectQuestionMode" class="btn btn-success">üîµ Ch·ªçn ·∫£nh c√¢u h·ªèi</button>
                    <button id="selectAnswerMode" class="btn btn-warning">üü† Ch·ªçn ·∫£nh ƒë√°p √°n</button>
                    <button id="clearSelection" class="btn btn-secondary">üóëÔ∏è X√≥a ch·ªçn</button>
                </div>

                <!-- Question Form -->
                <form id="questionForm">
                    <div class="form-group">
                        <label for="subject">üìñ M√¥n h·ªçc:</label>
                        <input type="text" id="subject" name="subject" placeholder="V√≠ d·ª•: To√°n h·ªçc">
                    </div>

                    <div class="form-group">
                        <label for="chapter">üìë Ch∆∞∆°ng:</label>
                        <input type="text" id="chapter" name="chapter" placeholder="V√≠ d·ª•: Ch∆∞∆°ng 1">
                    </div>

                    <div class="form-group">
                        <label for="lesson">üìÑ B√†i h·ªçc:</label>
                        <input type="text" id="lesson" name="lesson" placeholder="V√≠ d·ª•: B√†i 1">
                    </div>

                    <div class="form-group">
                        <label for="question">‚ùì C√¢u h·ªèi:</label>
                        <textarea id="question" name="question" placeholder="Nh·∫≠p c√¢u h·ªèi..." rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="answer">‚úÖ ƒê√°p √°n:</label>
                        <textarea id="answer" name="answer" placeholder="Nh·∫≠p ƒë√°p √°n..." rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="difficulty">üéöÔ∏è ƒê·ªô kh√≥:</label>
                        <select id="difficulty" name="difficulty">
                            <option value="easy">D·ªÖ</option>
                            <option value="medium">Trung b√¨nh</option>
                            <option value="hard">Kh√≥</option>
                            <option value="very_hard">R·∫•t kh√≥</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">‚ûï Th√™m c√¢u h·ªèi</button>
                </form>

                
            </div>

            <!-- Questions List Section -->
            <div class="questions-section">
                <div class="section-title">üìã Danh S√°ch C√¢u H·ªèi</div>
                <div id="questionsList" class="questions-list"></div>
            </div>

            <!-- JSON Viewer Section -->
            <div class="json-viewer-section">
                <div class="json-header">
                    <div class="section-title">üîß JSON Editor</div>
                    <div class="json-controls">
                        <button id="loadJsonBtn" class="btn btn-primary">üì• T·∫£i JSON</button>
                        <button id="saveJsonBtn" class="btn btn-success">üíæ L∆∞u JSON</button>
                        <button onclick="formatJson()" class="btn btn-secondary">üé® Format</button>
                        <button onclick="validateJson()" class="btn btn-warning">‚úÖ Validate</button>
                    </div>
                </div>
                
                <div class="json-stats">
                    <div class="json-stats-text">
                        üí° Ch·ªânh s·ª≠a tr·ª±c ti·∫øp file JSON mapping. Nh·ªõ validate tr∆∞·ªõc khi l∆∞u!
                    </div>
                </div>
                
                <div class="json-editor-container">
                    <textarea id="jsonEditor" class="json-editor" placeholder="JSON content s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>‚úèÔ∏è Ch·ªânh s·ª≠a c√¢u h·ªèi</h2>
            
            <div class="form-group">
                <label for="editFolderSelect">üìÅ Ch·ªçn folder ·∫£nh:</label>
                <select id="editFolderSelect" class="folder-select" onchange="loadImagesFromFolderForEdit(this.value)">
                    <option value="">-- Ch·ªçn folder ·∫£nh --</option>
                </select>
            </div>

            <!-- Quick Actions for Edit Modal -->
            <div class="quick-actions">
                <div class="quick-actions-title">‚ö° Quick View</div>
                <div class="quick-actions-buttons">
                    <button onclick="showFullSizeImages()" class="quick-btn">üñºÔ∏è Full</button>
                    <button onclick="fitAllImages()" class="quick-btn">üîç Fit</button>
                    <button onclick="showCompactImages()" class="quick-btn">üì± Compact</button>
                </div>
            </div>

            <div id="editImagesGrid" class="images-grid"></div>

            <!-- Text Content Display for Edit -->
            <div id="editTextContentGroup" style="display: none;">
                <div class="text-content-header">
                    <h4>üìÑ N·ªôi dung Text:</h4>
                    <div>
                        <button id="editTextBtnModal" class="btn btn-small">‚úèÔ∏è S·ª≠a</button>
                        <button id="saveTextBtnModal" class="btn btn-small" style="display: none;">üíæ L∆∞u</button>
                        <button id="cancelTextBtnModal" class="btn btn-small" style="display: none;">‚ùå H·ªßy</button>
                    </div>
                </div>
                <div id="editTextDisplay" class="text-display"></div>
            </div>

            <div class="selection-buttons">
                <button id="editSelectQuestionMode" class="btn btn-success">üîµ Ch·ªçn ·∫£nh c√¢u h·ªèi</button>
                <button id="editSelectAnswerMode" class="btn btn-warning">üü† Ch·ªçn ·∫£nh ƒë√°p √°n</button>
                <button id="editClearSelection" class="btn btn-secondary">üóëÔ∏è X√≥a ch·ªçn</button>
            </div>

            <form id="editForm">
                <div class="form-group">
                    <label for="editSubject">üìñ M√¥n h·ªçc:</label>
                    <input type="text" id="editSubject" name="subject">
                </div>

                <div class="form-group">
                    <label for="editChapter">üìë Ch∆∞∆°ng:</label>
                    <input type="text" id="editChapter" name="chapter">
                </div>

                <div class="form-group">
                    <label for="editLesson">üìÑ B√†i h·ªçc:</label>
                    <input type="text" id="editLesson" name="lesson">
                </div>

                <div class="form-group">
                    <label for="editQuestion">‚ùì C√¢u h·ªèi:</label>
                    <textarea id="editQuestion" name="question" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="editAnswer">‚úÖ ƒê√°p √°n:</label>
                    <textarea id="editAnswer" name="answer" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="editDifficulty">üéöÔ∏è ƒê·ªô kh√≥:</label>
                    <select id="editDifficulty" name="difficulty">
                        <option value="easy">D·ªÖ</option>
                        <option value="medium">Trung b√¨nh</option>
                        <option value="hard">Kh√≥</option>
                        <option value="very_hard">R·∫•t kh√≥</option>
                    </select>
                </div>

                <div class="modal-buttons">
                    <button type="submit" class="btn btn-primary">üíæ C·∫≠p nh·∫≠t</button>
                    <button type="button" id="cancelEdit" class="btn btn-secondary">‚ùå H·ªßy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" class="modal">
        <div class="modal-content image-preview-modal">
            <span class="close">&times;</span>
            <div class="image-preview-container">
                <img id="previewImage" alt="Image Preview">
                <div class="image-info">
                    <p id="imagePath"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload PDF Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>üì§ Upload PDF</h2>
            
            <div class="upload-info">
                <h3>üìã Quy tr√¨nh x·ª≠ l√Ω:</h3>
                <ol>
                    <li>Chuy·ªÉn ƒë·ªïi PDF th√†nh ·∫£nh</li>
                    <li>YOLO Detection ƒë·ªÉ t√¨m c√¢u h·ªèi/ƒë√°p √°n</li>
                    <li>Crop v√† l∆∞u ·∫£nh</li>
                    <li>OCR ƒë·ªÉ tr√≠ch xu·∫•t text</li>
                    <li>T·∫°o c·∫•u tr√∫c folder v√† file</li>
                </ol>
                <p><strong>L∆∞u √Ω:</strong> Qu√° tr√¨nh c√≥ th·ªÉ m·∫•t v√†i ph√∫t t√πy theo k√≠ch th∆∞·ªõc file.</p>
            </div>

            <form id="uploadForm">
                <div class="form-group">
                    <label for="pdfFile">üìÑ Ch·ªçn file PDF:</label>
                    <input type="file" id="pdfFile" name="pdf_file" accept=".pdf" required>
                </div>

                <div id="fileInfo" class="file-info" style="display: none;">
                    <p><strong>üìÑ T√™n file:</strong> <span id="fileName"></span></p>
                    <p><strong>üíæ K√≠ch th∆∞·ªõc:</strong> <span id="fileSize"></span></p>
                </div>

                <div class="form-group">
                    <label for="bookName">üìö T√™n s√°ch:</label>
                    <input type="text" id="bookName" name="book_name" 
                           placeholder="V√≠ d·ª•: toan_lop_6" 
                           pattern="[a-zA-Z0-9_-]+" 
                           title="Ch·ªâ ƒë∆∞·ª£c s·ª≠ d·ª•ng ch·ªØ c√°i, s·ªë, d·∫•u g·∫°ch d∆∞·ªõi v√† g·∫°ch ngang"
                           required>
                    <small>Ch·ªâ ƒë∆∞·ª£c s·ª≠ d·ª•ng ch·ªØ c√°i, s·ªë, d·∫•u g·∫°ch d∆∞·ªõi (_) v√† g·∫°ch ngang (-)</small>
                </div>

                <div id="uploadProgress" class="upload-progress" style="display: none;">
                    <div class="progress-bar-container">
                        <div id="progressBar" class="progress-bar"></div>
                    </div>
                    <div id="progressText" class="progress-text">ƒêang upload...</div>
                </div>

                <div class="modal-buttons">
                    <button type="submit" id="submitUpload" class="btn btn-primary">üöÄ B·∫Øt ƒë·∫ßu x·ª≠ l√Ω</button>
                    <button type="button" id="cancelUpload" class="btn btn-secondary">‚ùå H·ªßy</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    
    <!-- Auto-apply preferences and additional scripts -->
    <script>
        // Auto-apply preferences khi load trang
        document.addEventListener('DOMContentLoaded', function() {
            // Delay ƒë·ªÉ ƒë·∫£m b·∫£o c√°c elements ƒë√£ ƒë∆∞·ª£c render
            setTimeout(function() {
                if (window.currentImageViewMode) {
                    setImageViewMode(window.currentImageViewMode);
                }
                if (window.currentImageGridSize) {
                    setImageGridSize(window.currentImageGridSize);
                }
            }, 500);
        });

        // Tab switching functionality
        function showTab(tabName) {
            // Update active tab button
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show relevant content based on tab
            switch(tabName) {
                case 'mapping':
                    // Already the main view, nothing to change
                    break;
                case 'upload':
                    showUploadModal();
                    break;
                case 'gallery':
                    window.open('/gallery', '_blank');
                    break;
            }
        }

        // Enhanced error handling
        window.addEventListener('error', function(e) {
            console.error('JavaScript Error:', e.error);
            showAlert('C√≥ l·ªói JavaScript x·∫£y ra. Vui l√≤ng refresh trang.', 'error');
        });

        // Enhanced image loading
        document.addEventListener('imagesLoaded', function() {
            console.log('Images loaded, applying preferences...');
            
            // Apply current view mode to all new images
            setTimeout(() => {
                if (window.currentImageViewMode) {
                    setImageViewMode(window.currentImageViewMode);
                }
                if (window.currentImageGridSize) {
                    setImageGridSize(window.currentImageGridSize);
                }
            }, 100);
        });

        // Performance monitoring
        let imageLoadTimes = [];
        
        function trackImageLoadTime(startTime, imagePath) {
            const loadTime = performance.now() - startTime;
            imageLoadTimes.push({ path: imagePath, time: loadTime });
            
            // Log slow loading images
            if (loadTime > 2000) {
                console.warn(`Slow image load: ${imagePath} took ${loadTime.toFixed(2)}ms`);
            }
        }

        // Auto-save preferences
        setInterval(function() {
            if (window.currentImageViewMode && window.currentImageGridSize) {
                localStorage.setItem('imageViewMode', window.currentImageViewMode);
                localStorage.setItem('imageGridSize', window.currentImageGridSize);
            }
        }, 30000); // Save every 30 seconds

        // Debug mode toggle
        let debugMode = localStorage.getItem('debugMode') === 'true';
        
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                debugMode = !debugMode;
                localStorage.setItem('debugMode', debugMode);
                
                if (debugMode) {
                    showAlert('Debug mode ON - Chi ti·∫øt log s·∫Ω hi·ªÉn th·ªã trong console', 'success');
                    console.log('Debug info:', {
                        currentBook,
                        currentImageViewMode,
                        currentImageGridSize,
                        selectedQuestionImages,
                        selectedAnswerImages,
                        allImages
                    });
                } else {
                    showAlert('Debug mode OFF', 'success');
                }
            }
        });
    </script>
</body>
</html>